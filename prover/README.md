# Prover

This crate contains two binaries:

- `prover` - A Pub/Sub service that processes proof generation requests
- `setup` - A one-time setup script that generates Groth16 keys and verifier contract

## Setup Binary

Generates the Groth16 proving key, verification key, and `Groth16Verifier.sol` contract.

```bash
cargo run --release --bin setup
```

Environment variables:

| Variable | Description | Default |
|----------|-------------|---------|
| `ELF_PATH` | Path to the RISC-V ELF binary | `../app/elf/riscv32im-pico-zkvm-elf` |
| `OUTPUT_DIR` | Directory for output artifacts | `prover/data` |

Generated files in `OUTPUT_DIR`:

- `vm_pk` - Proving Key
- `vm_vk` - Verification Key
- `Groth16Verifier.sol` - Solidity verifier contract
- `inputs.json` - Test proof data

## Prover Service

A long-running application that subscribes to a Google Cloud Pub/Sub subscription, processes proof generation requests, and publishes the results to a specified topic.

### Configuration

| Variable | Description | Default |
|----------|-------------|---------|
| `GCP_PROJECT_ID` | Google Cloud Project ID | (Required) |
| `PROVER_SUBSCRIPTION` | Pub/Sub subscription ID for incoming requests | (Required) |
| `RESULT_TOPIC` | Pub/Sub topic ID for publishing results | (Required) |
| `MAX_CONCURRENT_PROOFS` | Max concurrent proof generation tasks | `2` |
| `PROOF_TIMEOUT_SECS` | Timeout for a single proof generation (seconds) | `3600` |
| `ELF_PATH` | Path to the RISC-V ELF binary | `../app/elf/riscv32im-pico-zkvm-elf` |
| `OUTPUT_DIR` | Directory for storing proof artifacts | `data` |
| `LOG_LEVEL` | Logging level (info, debug, trace) | `info` |

### Usage

1. **Run the setup first** (if not already done):

   ```bash
   cargo run --release --bin setup
   ```

2. **Set up environment variables:**

   ```bash
   export GCP_PROJECT_ID=your-project-id
   export PROVER_SUBSCRIPTION=prover-requests-sub
   export RESULT_TOPIC=prover-results
   ```

3. **Run the service:**

   ```bash
   cargo run --release --bin prover
   ```

### Local Development (with Emulator)

```bash
export PUBSUB_EMULATOR_HOST=localhost:8085
export GCP_PROJECT_ID=test-project
export PROVER_SUBSCRIPTION=prover-requests-sub
export RESULT_TOPIC=prover-results

cargo run --release --bin prover
```

### Groth16 Setup Files

The prover service requires pre-generated Groth16 setup files in the `OUTPUT_DIR` (default: `data/`):

- `vm_pk` - Proving Key
- `vm_vk` - Verification Key

These files are generated by running `cargo run --release --bin setup`. The service will fail to start if these files are missing.

If you modify the circuit logic in `app/src/main.rs`, you must regenerate the setup files and redeploy the verifier contract.
